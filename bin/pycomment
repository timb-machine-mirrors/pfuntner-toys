#! /usr/bin/env python

"""
   A vi command to comment-out and un-comment a section of Python code
"""

import re
import sys
import copy

def len_of_group1(match):
  if match:
    return len(match.group(1))
  else:
    return None

def all_commented_out(lengths):
  lengths = set(lengths)
  return (len(lengths) == 1) and (lengths != set([None]))

assert not sys.stdin.isatty(), 'stdin must be redirected'

errors = 0
lines = sys.stdin.read().splitlines()
newlines = copy.deepcopy(lines)

# is the block completely commented out at the same column?
regexp = re.compile('^(\s*)#( |$)')
if all_commented_out([len_of_group1(regexp.search(line)) for line in lines]):
  regexp = re.compile('^\s*(#( |$))')
  for (pos, newline) in enumerate(newlines):
    match = regexp.search(newline)
    newlines[pos] = newline[:match.start(1)] + newline[match.end(1):]
else:
  # find least indented line
  regexp = re.compile('(^\s*)\S')
  indents = []
  for newline in newlines:
    match = regexp.search(newline)
    if match:
      indents.append(len(match.group(1)))
  if indents:
    least_indent = min(indents)
    regexp = re.compile('(^\s{{{least_indent}}})'.format(**locals()))
    for (pos, newline) in enumerate(newlines):
      newlines[pos] = regexp.sub(r'\1' + '# ', newline)

if errors:
  print '\n'.join(lines)
else:
  print '\n'.join(newlines)
