#! /usr/bin/env python

import os
import re
import sys
import socket
import logging
import argparse
import datetime
import subprocess

def warn(msg):
  log.info(msg)

def smartSplit(obj):
  if isinstance(obj, basestring):
    obj = obj.splitlines()
  if isinstance(obj, list) and len(obj) == 1:
    obj = obj[0]
  return obj

def show(expr):
  try:
    value = eval(expr)
  except Exception as e:
    warn('Caught {e!s} while evaluating {value!r}'.format(**locals()))
  else:
    value = smartSplit(value)
    print '{expr}: {value!r}'.format(**locals())

def cat(filename):
  if os.path.exists(filename):
    if os.path.isfile(filename):
      try:
        with open(filename) as stream:
          data = stream.read().splitlines()
      except Exception as e:
        warn('Caught {e!s} reading {filename!s}'.format(**locals()))
      else:
        print '{filename!r}: {data}'.format(**locals())
    else:
      log.info('{filename!r} is not a file'.format(**locals()))
  else:
    log.info('{filename!r} does not exist'.format(**locals()))

def run(cmd, silent=False):
  ret = ''

  if isinstance(cmd, str):
    cmd = cmd.split()
  try:
    p = subprocess.Popen(cmd, stdout=subprocess.PIPE, stderr=subprocess.PIPE)
  except Exception as e:
    warn('Caught {e!s} from {cmd}'.format(**locals()))
  else:
    (stdout, stderr) = p.communicate()
    rc = p.wait()
    log.debug('run({cmd}): {rc}, {stdout!r}, {stderr!r}'.format(**locals()))
    if stdout:
      ret = stdout
      if not silent:
        stdout = smartSplit(stdout)
        print '{cmd}: {stdout!r}'.format(**locals())

  return ret

def parse_fixed_table(data):
  ret = {}
  data = data.replace('\r', '').splitlines()
  log.debug('data: {data}'.format(**locals()))
  if len(data) > 1:
    headings = re.findall(r'\w+\s+', data[0])
    pos = 0
    log.debug('data[1]: {data}'.format(data=data[1]))
    for colnum in range(len(headings)):
      log.debug('{colnum} {pos} {remain!r}'.format(remain=data[1][pos:], **locals()))
      ret[headings[colnum].strip()] = data[1][pos:pos+len(headings[colnum])].strip()
      pos += len(headings[colnum])
  log.debug('fixed table: {ret}'.format(**locals()))
  return ret

parser = argparse.ArgumentParser(description='General "what am I" with respect to host system')
parser.add_argument('-v', '--verbose', dest='verbose', action='store_true', help='Enable debugging')
args = parser.parse_args()

logging.basicConfig(format='%(asctime)s %(levelname)s %(pathname)s:%(lineno)d %(msg)s')
log = logging.getLogger()
log.setLevel(logging.DEBUG if args.verbose else logging.WARNING)

print 'It is {!s}'.format(datetime.datetime.utcnow())
print
run('uname -a')
run('uname -n')
run('uname -s')
run('uname -v')
run('uname -r')
run('uname -m')
run('uname -p')
run('uname -i')
run('uname -o')

print ''
cat('/etc/system-release')
show('sys.version')
show('sys.platform')
show('sys.path')

print ''
show('socket.gethostname()')
show('socket.gethostbyname(socket.gethostname())')

if 'win' in sys.platform.lower():
  out = run('ipconfig', silent=True)
  """
    Wireless LAN adapter Wi-Fi:
    
       Connection-specific DNS Suffix  . : cisco.com
       IPv6 Address. . . . . . . . . . . : 2001:420:2160:1280:c87b:506d:9252:1a2f
       Link-local IPv6 Address . . . . . : fe80::8ce3:d8ea:8f47:19c2%24
       IPv4 Address. . . . . . . . . . . : 10.150.160.21
       Subnet Mask . . . . . . . . . . . : 255.255.252.0
       Default Gateway . . . . . . . . . : fe80::5:73ff:fea0:3e9%24
                                           10.150.160.1
  """
  ipconfig_adapter_regexp = re.compile('^([A-Z][^:]+):')
  ipconfig_attr_regexp = re.compile(r'^\s+([^.]+)(?=[ .]*): (\S+)')

  adapter = None
  attrs = {}
  for line in out.splitlines():
    match = ipconfig_adapter_regexp.search(line)
    if match:
      if 'IPv4 Address' in attrs:
        break
      adapter = match.group(1)
      attrs = { 'adapter': adapter }
      if 'VirtualBox' in adapter:
        adapter = None
      log.debug('Adapter match: {adapter!r} {line!r}'.format(**locals()))
    elif adapter:
      match = ipconfig_attr_regexp.search(line)
      if match:
        log.debug('Attr match: {groups} {line!r}'.format(match.groups(), **locals()))
        attrs[match.group(1).strip()] = match.group(2).strip()
      else:
        log.debug('Failed to match attr regexp: {line!r} {ipconfig_attr_regexp.pattern!r}'.format(**locals()))

  log.debug('attrs: {attrs}'.format(**locals()))
  if 'IPv4 Address' in attrs:
    print 'IP: {ip} ({adapter})'.format(ip=attrs['IPv4 Address'], **locals())

  """
    $ wmic MemoryChip get Capacity, BankLabel
    BankLabel  Capacity
    BANK 0     8589934592
    BANK 2     8589934592
  """
  print ''

  out = run('wmic MemoryChip get Capacity, BankLabel', silent=True)
  if out:
    out = out.splitlines()
    ram = 0
    for line in out[1:]:
      bytes = 0
      tokens = line.split()
      try:
        bytes = int(tokens[-1])
      except:
        pass
      else:
        ram += bytes
    if ram:
      units = 'b'
      if ram > 1000:
        ram /= 1024
        units = 'KB'
        if ram > 1000:
          ram /= 1024
          units = 'MB'
          if ram > 1000:
            ram /= 1024
            units = 'GB'
      print 'RAM: {ram} {units}'.format(**locals())

  """
    $ wmic cpu list | table --fixed --rotate --headings
    000000 00 AddressWidth                     64
    000000 01 Architecture                     9
    000000 02 Availability                     3
    000000 03 Caption                          Intel64 Family 6 Model 142 Stepping 10
    000000 04 ConfigManagerErrorCode
    000000 05 ConfigManagerUserConfig
    000000 06 CpuStatus                        1
    000000 07 CreationClassName                Win32_Processor
    000000 08 CurrentClockSpeed                1910
    000000 09 CurrentVoltage                   12
    000000 10 DataWidth                        64
    000000 11 Description                      Intel64 Family 6 Model 142 Stepping 10
    000000 12 DeviceID                         CPU0
    000000 13 ErrorCleared
    000000 14 ErrorDescription
    000000 15 ExtClock                         100
    000000 16 Family                           198
    000000 17 InstallDate
    000000 18 L2CacheSize                      1024
    000000 19 L2CacheSpeed
    000000 20 LastErrorCode
    000000 21 Level                            6
    000000 22 LoadPercentage                   10
    000000 23 Manufacturer                     GenuineIntel
    000000 24 MaxClockSpeed                    2112
    000000 25 Name                             Intel(R) Core(TM) i7-8650U CPU @ 1.90GHz
    000000 26 OtherFamilyDescription
  """
  out = run('wmic cpu list', silent=True)
  cpu_table = parse_fixed_table(out)

  cpu_name = cpu_table.get('Name')
  if cpu_name:
    print 'CPU name: {cpu_name}'.format(**locals())
